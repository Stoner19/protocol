#!/bin/bash

export CMD=$OLSCRIPT


if [ -z "$1" ]; then
	name="David"
else 
	name=$1
fi

nodeName=`olconfig get -c $name -p NodeName`
p2pAddress=`olconfig get -c $name -p P2PAddress`
rpcAddress=`olconfig get -c $name -p RpcAddress`
appAddress=`olconfig get -c $name -p AppAddress`
peers=`olconfig get --peers -p Alice -p Bob -p Carol -p David -p Emma`

export WORK=$OLDATA/$nodeName
export LOG=$WORK
export DATA=$WORK/tendermint

pushd $WORK > /dev/null

#
# Startup Tendermint consensus
#
pids=`pgrep -f "tendermint.*--home $DATA.*"`
if [ -z "$pids" ]

then
	echo "============================================================" >> $LOG/tendermint.log
	echo "Starting Tendermint" >> $LOG/tendermint.log
	echo "============================================================" >> $LOG/tendermint.log

	tendermint node --home $DATA \
		--moniker $nodeName \
		--rpc.laddr $rpcAddress \
		--p2p.laddr $p2pAddress \
		--proxy_app $appAddress \
		--p2p.persistent_peers $peers \
		--log_level="state:error,mempool:error,*:error" \
		>> $LOG/tendermint.log 2>&1 &
else
	echo "Tendermint $nodeName was already running"
fi

#
# Startup OLFullnode
#
pids=`pgrep -f "olfullnode.*-c $name.*"`
if [ -z "$pids" ]

then
	echo "============================================================" >> $LOG/olfullnode.log
	echo "Starting OLFullnode" >> $LOG/olfullnode.log
	echo "============================================================" >> $LOG/olfullnode.log
	olfullnode node -c $name\
		--root $WORK/olfullnode \
		--tendermintRoot $DATA \
		>> $LOG/olfullnode.log 2>&1 &

	echo "$nodeName has been started"
else
	echo "OLFullnode $nodeName was already running"
fi

popd >> /dev/null
